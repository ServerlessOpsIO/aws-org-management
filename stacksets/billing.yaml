AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS account infrastructure stackset (billing)

Parameters:
  TargetOuIds:
    Type: CommaDelimitedList
    Description: List of OUs
  TargetRegions:
    Type: CommaDelimitedList
    Description: Regions to deploy to

Resources:
  OrgBilling:
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: OrgBilling
      Description: Billing Alarms
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds: !Ref TargetOuIds
          Regions: !Ref TargetRegions
      AutoDeployment:
        Enabled: True
        RetainStacksOnAccountRemoval: True
      ManagedExecution:
        Active: true
      OperationPreferences:
        RegionConcurrencyType: PARALLEL
        FailureToleranceCount: 1
        MaxConcurrentCount: 5
      PermissionModel: SERVICE_MANAGED
      TemplateBody: |
        AWSTemplateFormatVersion: '2010-09-09'
        Description: AWS account infrastructure (billing)
        Resources:
          BillingAlarmSnsTopic:
            Type: "AWS::SNS::Topic"
            Properties:
              DisplayName: BillingAlarms
              Subscription:
                - Endpoint: !Sub "admin+aws-billing-${AWS::AccountId}@serverlessops.io"
                  Protocol: email

          BillingAlarm10:
            Type: "AWS::CloudWatch::Alarm"
            Properties:
              ComparisonOperator: "GreaterThanOrEqualToThreshold"
              EvaluationPeriods: 1
              Period: 21600
              Namespace: "AWS/Billing"
              MetricName: "EstimatedCharges"
              Dimensions:
                - Name: "Currency"
                  Value: "USD"
              Statistic: "Maximum"
              Threshold: 10
              AlarmActions:
                - Ref: BillingAlarmSnsTopic

          BillingAlarm25:
            Type: "AWS::CloudWatch::Alarm"
            Properties:
              ComparisonOperator: "GreaterThanOrEqualToThreshold"
              EvaluationPeriods: 1
              Period: 21600
              Namespace: "AWS/Billing"
              MetricName: "EstimatedCharges"
              Dimensions:
                - Name: "Currency"
                  Value: "USD"
              Statistic: "Maximum"
              Threshold: 25
              AlarmActions:
                - Ref: BillingAlarmSnsTopic

          BillingAlarm50:
            Type: "AWS::CloudWatch::Alarm"
            Properties:
              ComparisonOperator: "GreaterThanOrEqualToThreshold"
              EvaluationPeriods: 1
              Period: 21600
              Namespace: "AWS/Billing"
              MetricName: "EstimatedCharges"
              Dimensions:
                - Name: "Currency"
                  Value: "USD"
              Statistic: "Maximum"
              Threshold: 50
              AlarmActions:
                - Ref: BillingAlarmSnsTopic